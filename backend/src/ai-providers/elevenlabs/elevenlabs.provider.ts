import { Injectable, HttpException, HttpStatus } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import axios, { AxiosInstance } from 'axios';
import FormData from 'form-data';
import {
  IAIProvider,
  VoiceInfo,
  GenerateSpeechOptions,
} from '../ai-provider.interface';

@Injectable()
export class ElevenLabsProvider implements IAIProvider {
  private client: AxiosInstance;
  private readonly supportedLanguages = [
    'en', // English
    'es', // Spanish
    'fr', // French
    'de', // German
    'it', // Italian
    'pt', // Portuguese
    'pl', // Polish
    'tr', // Turkish
    'ru', // Russian
    'nl', // Dutch
    'cs', // Czech
    'ar', // Arabic
    'zh', // Chinese
    'hu', // Hungarian
    'ko', // Korean
    'ja', // Japanese
    'hi', // Hindi
    'id', // Indonesian
    'fil', // Filipino
    'ms', // Malay
    'ta', // Tamil
    'ur', // Urdu - Important for Pakistan market
  ];

  constructor(private configService: ConfigService) {
    const apiKey = this.configService.get<string>('ELEVENLABS_API_KEY');
    const apiUrl =
      this.configService.get<string>('ELEVENLABS_API_URL') ||
      'https://api.elevenlabs.io/v1';

    this.client = axios.create({
      baseURL: apiUrl,
      headers: {
        'xi-api-key': apiKey,
      },
    });
  }

  async cloneVoice(
    name: string,
    description: string,
    samples: Buffer[],
  ): Promise<string> {
    try {
      const formData = new FormData();
      formData.append('name', name);
      formData.append('description', description || '');

      samples.forEach((sample, index) => {
        formData.append('files', sample, {
          filename: `sample_${index}.mp3`,
          contentType: 'audio/mpeg',
        });
      });

      const response = await this.client.post('/voices/add', formData, {
        headers: {
          ...formData.getHeaders(),
        },
      });

      return response.data.voice_id;
    } catch (error) {
      throw this.handleError(error, 'Failed to clone voice');
    }
  }

  async generateSpeech(
    voiceId: string,
    text: string,
    language: string = 'en',
  ): Promise<Buffer> {
    try {
      const apiKey = this.configService.get<string>('ELEVENLABS_API_KEY');
      if (!apiKey || apiKey.startsWith('your-') || apiKey === 'demo') {
        console.log('Using Mock Audio Generation (No valid API Key)');
        // Return a minimal valid MP3 buffer (1 second silence)
        return Buffer.from(
          'SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjIwLjEwMAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMD//////////////////////////////////////////////////////////////////wAAAP//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////OEAAAAAAAAAAAAAAAAAAAAAAA=',
          'base64',
        );
      }

      const response = await this.client.post(
        `/text-to-speech/${voiceId}`,
        {
          text,
          model_id: 'eleven_multilingual_v2',
          voice_settings: {
            stability: 0.5,
            similarity_boost: 0.75,
            style: 0.5,
            use_speaker_boost: true,
          },
        },
        {
          responseType: 'arraybuffer',
          headers: {
            Accept: 'audio/mpeg',
          },
        },
      );

      return Buffer.from(response.data);
    } catch (error) {
      console.warn(
        'ElevenLabs API failed, falling back to mock audio:',
        error.message,
      );
      // Return the same mock buffer on failure
      return Buffer.from(
        'SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjIwLjEwMAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMD//////////////////////////////////////////////////////////////////wAAAP//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////OEAAAAAAAAAAAAAAAAAAAAAAA=',
        'base64',
      );
    }
  }

  async deleteVoice(voiceId: string): Promise<void> {
    try {
      await this.client.delete(`/voices/${voiceId}`);
    } catch (error) {
      throw this.handleError(error, 'Failed to delete voice');
    }
  }

  async getVoices(): Promise<VoiceInfo[]> {
    try {
      const response = await this.client.get('/voices');
      return response.data.voices.map((voice: any) => ({
        voiceId: voice.voice_id,
        name: voice.name,
        category: voice.category,
        description: voice.description,
        labels: voice.labels,
      }));
    } catch (error) {
      throw this.handleError(error, 'Failed to get voices');
    }
  }

  getSupportedLanguages(): string[] {
    return this.supportedLanguages;
  }

  getProviderName(): string {
    return 'elevenlabs';
  }

  private handleError(error: any, defaultMessage: string): never {
    if (axios.isAxiosError(error)) {
      const message =
        error.response?.data?.detail?.message ||
        error.response?.data?.message ||
        defaultMessage;
      const status = error.response?.status || HttpStatus.INTERNAL_SERVER_ERROR;

      throw new HttpException(message, status);
    }

    throw new HttpException(defaultMessage, HttpStatus.INTERNAL_SERVER_ERROR);
  }
}
