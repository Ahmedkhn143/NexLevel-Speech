// NexLevel Speech - AI Voice Cloning SaaS Platform
// SQLite Development Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ============== USERS ==============
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String?   // Null for OAuth users
  name          String?
  avatarUrl     String?
  googleId      String?   @unique
  emailVerified Boolean   @default(false)
  isActive      Boolean   @default(true)
  role          String    @default("USER")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  subscription  Subscription?
  credits       Credit?
  voices        Voice[]
  generations   Generation[]
  payments      Payment[]
  usageRecords  UsageRecord[]

  @@index([email])
  @@index([googleId])
}

// ============== PLANS ==============
model Plan {
  id              String   @id @default(uuid())
  name            String   @unique  // starter, creator, pro
  displayName     String             // "Starter", "Creator", "Pro"
  description     String?
  monthlyPricePKR Int                // Price in PKR
  yearlyPricePKR  Int                // Yearly price (discounted)
  creditsPerMonth Int                // Character credits
  maxVoiceClones  Int                // Max voice clones allowed
  features        String             // Feature list as JSON string
  isActive        Boolean  @default(true)
  isFree          Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  subscriptions   Subscription[]

  @@index([name])
}

// ============== SUBSCRIPTIONS ==============
model Subscription {
  id                 String   @id @default(uuid())
  userId             String   @unique
  planId             String
  status             String   @default("ACTIVE")
  billingCycle       String   @default("MONTHLY")
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelledAt        DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan Plan @relation(fields: [planId], references: [id])

  @@index([userId])
  @@index([status])
}

// ============== CREDITS ==============
model Credit {
  id           String   @id @default(uuid())
  userId       String   @unique
  totalCredits Int      @default(0)
  usedCredits  Int      @default(0)
  bonusCredits Int      @default(0)
  lastResetAt  DateTime @default(now())
  nextResetAt  DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============== VOICES ==============
model Voice {
  id              String   @id @default(uuid())
  userId          String
  name            String
  description     String?
  externalVoiceId String
  provider        String   @default("ELEVENLABS")
  sampleUrls      String   @default("[]") // JSON array as string
  status          String   @default("PROCESSING")
  consentGiven    Boolean  @default(false)
  consentDate     DateTime?
  metadata        String?  // JSON as string
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  generations Generation[]

  @@index([userId])
  @@index([externalVoiceId])
}

// ============== GENERATIONS ==============
model Generation {
  id             String   @id @default(uuid())
  userId         String
  voiceId        String
  text           String
  characterCount Int
  language       String   @default("en")
  audioUrl       String?
  format         String   @default("MP3")
  status         String   @default("PROCESSING")
  duration       Float?
  creditsCost    Int
  errorMessage   String?
  metadata       String?
  createdAt      DateTime @default(now())

  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  voice Voice @relation(fields: [voiceId], references: [id])

  @@index([userId])
  @@index([voiceId])
  @@index([createdAt])
}

// ============== PAYMENTS ==============
model Payment {
  id                String    @id @default(uuid())
  userId            String
  amount            Int
  currency          String    @default("PKR")
  provider          String
  providerTxnId     String?
  providerReference String?
  status            String    @default("PENDING")
  planId            String?
  billingCycle      String?
  metadata          String?
  failureReason     String?
  receiptUrl        String?
  paidAt            DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([providerTxnId])
  @@index([status])
}

// ============== USAGE RECORDS ==============
model UsageRecord {
  id          String   @id @default(uuid())
  userId      String
  type        String
  creditsUsed Int
  description String?
  referenceId String?
  createdAt   DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
}
