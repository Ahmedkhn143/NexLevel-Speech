# NexLevel Speech - Architecture & System Design (2026)

## üèó Global Tech Stack

### Frontend (Client)
- **Framework**: Next.js 15+ (App Router, React Server Components)
- **Language**: TypeScript 5.4+ (Strict Mode)
- **Styling**: Tailwind CSS v4 + Framer Motion v12
- **State Management**: Zustand (Persisted Auth Store)
- **UI Components**: Shadcn/UI (Radix Primitives)
- **Packaging**: Docker Optimized

### Backend (Server)
- **Runtime**: Node.js 22 LTS
- **Framework**: NestJS v11 (Modular Monolith)
- **Database**: PostgreSQL 16
- **ORM**: Prisma v6
- **Queue**: BullMQ + Redis (for TTS jobs)
- **Storage**: AWS S3 compatible (R2)

---

## üìÇ Project Structure

### Frontend (`/frontend`)
```
src/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ (auth)/             # Login/Signup Routes
‚îÇ   ‚îú‚îÄ‚îÄ app/                # Authenticated App Routes (Protected)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard/      # Main Dashboard
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ voices/         # Voice Cloning Studio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tts/            # Text-to-Speech Engine
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings/       # User Settings
‚îÇ   ‚îú‚îÄ‚îÄ api/                # Next.js API Routes (Proxy)
‚îÇ   ‚îú‚îÄ‚îÄ globals.css         # Tailwind v4 Configuration
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx          # Root Layout
‚îÇ   ‚îî‚îÄ‚îÄ page.tsx            # Marketing Landing Page
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ landing/            # Landing Page Components (Hero, Demo, etc.)
‚îÇ   ‚îú‚îÄ‚îÄ ui/                 # Reusable Design System (Card, Button, Modal)
‚îÇ   ‚îî‚îÄ‚îÄ layout/             # App Layout (Sidebar, Header)
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ api.ts              # Axios Instance with Interceptors
‚îÇ   ‚îî‚îÄ‚îÄ utils.ts            # Helper Functions
‚îú‚îÄ‚îÄ stores/                 # Zustand Stores (Auth, UI)
‚îî‚îÄ‚îÄ middleware.ts           # Server-side Route Protection
```

### Backend (`/backend`)
```
src/
‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îú‚îÄ‚îÄ auth/               # Authentication (JWT, RBAC)
‚îÇ   ‚îú‚îÄ‚îÄ user/               # User Management
‚îÇ   ‚îú‚îÄ‚îÄ voice/              # Voice Cloning Logic (ElevenLabs wrapper)
‚îÇ   ‚îú‚îÄ‚îÄ tts/                # TTS Logic (Streaming, Cost Calculation)
‚îÇ   ‚îú‚îÄ‚îÄ payment/            # Payment Engine (JazzCash, EasyPaisa, Stripe)
‚îÇ   ‚îî‚îÄ‚îÄ prisma/             # DB Connection Module
‚îú‚îÄ‚îÄ common/
‚îÇ   ‚îú‚îÄ‚îÄ decorators/         # @CurrentUser, @Public
‚îÇ   ‚îú‚îÄ‚îÄ guards/             # JwtAuthGuard, RolesGuard
‚îÇ   ‚îú‚îÄ‚îÄ filters/            # Global Exception Filters
‚îÇ   ‚îî‚îÄ‚îÄ interceptors/       # Logging & Transform Interceptors
‚îú‚îÄ‚îÄ config/                 # Environment Configuration
‚îú‚îÄ‚îÄ app.module.ts           # Root Module
‚îî‚îÄ‚îÄ main.ts                 # Entry Point
```

---

## üß† AI Engine Logic

### Provider Abstraction
The system is designed to be provider-agnostic. Currently uses ElevenLabs, but ready for OpenVoice/XTTS.
- **Service**: `ElevenLabsProvider` implements `ITextToSpeechProvider`.
- **Logic**:
  1. Frontend sends text + voice ID.
  2. Backend validates balance (Atomic Transaction).
  3. Backend calls Provider API.
  4. Backend streams audio buffer/URL to client.
  5. Deducts credits ONLY on success.

### Voice Cloning
- **Flow**: Upload -> Validate Format -> Send to Training API -> Poll Status -> Store ID.
- **Security**: Requires explicit "Consent" flag. File type validation (mp3/wav).

---

## üí≥ Payment Engine (Pakistan + Global)

### Architecture
- **Transactions**: Atomic operations using `prisma.$transaction`.
- **Providers**:
  - **JazzCash/EasyPaisa**: Webhook-based integration.
  - **Manual**: Admin-approval flow.
- **Security**:
  - Webhook Signature Verification (`verifyWebhook`).
  - Idempotency Keys to prevent double-charging.
  - Audit Logging of all credit changes.

---

## üõ°Ô∏è Security Considerations
1. **Middleware Guard**: `middleware.ts` enforcement on `/app/*`.
2. **Strict CORS**: Whitelisted origins only.
3. **Rate Limiting**: Redis-based throttling on TTS endpoints.
4. **Input Validation**: Zod/Class-Validator on all DTOs.
5. **Secret Management**: `.env` files (never committed).

---

## üìà Scaling Strategy
1. **Horizontal Scaling**: Stateless backend (JWT). Spin up N instances behind Load Balancer.
2. **Database**: PostgreSQL Connection Pooling (Prisma Accelerate or PgBouncer).
3. **Caching**: Redis for User Profiles and Voice Lists.
4. **Async Processing**: BullMQ for long-running cloning tasks.

---

## üí∞ Cost Control
1. **Credit System**: 1 Character = 1 Credit.
2. **Hard Limits**: Max characters per request (10,000 for Pro).
3. **Monitoring**: Alerts on abnormal API usage (Cost Anomaly Detection).

---

*Generated by Architecture Agent - 2026*
